function manageStops(n,t,i,r,u,f){r.selectedStop={};r.allstates="";r.stopDialog=!1;r.statesCodes=[];r.states=[];r.SearchAddress="";r.current=1;r.BuildingType=["Residential","Commercial","Government"];r.Buildings=[];r.BuildingsCodes=[];r.loadFirstTime=!0;r.RefreshStops=function(){r.$parent.UpdateQuicklook();n.GetAllStops(r.selectedQuote.Lookup).then(function(n){r.$parent.selectedQuote.Stops=n;r.SetDistanceTimes()})};r.franchiseAddress="";r.franchiseID="";r.GetFranchise=function(){r.$parent.selectedQuote.Lookup!=""&&n.GetQuoteFranchise(r.$parent.selectedQuote.Lookup).then(function(n){r.franchiseAddress=n.franchiseAddress;r.franchiseID=n.franchiseID;r.SetDistanceTimes()})};r.SetDistanceTimes=function(){if(typeof r.selectedQuote.Stops!="undefined"&&r.selectedQuote.Stops.length>0){for(var n=0;n<r.selectedQuote.Stops.length;n++)(function(n){var t="",i="";n==0?(t=r.franchiseID,i=r.selectedQuote.Stops[n].addressid):(t=r.selectedQuote.Stops[n-1].addressid,i=r.selectedQuote.Stops[n].addressid);r.SetDistanceTimesForStop(n,t,i)})(n);t.GetDistanceTime(r.selectedQuote.Stops[r.selectedQuote.Stops.length-1].addressid,r.franchiseID).then(function(n){r.DistanceFromLastStop=n.distance;r.TimeFromLastStop=n.time})}};r.SetDistanceTimesForStop=function(n,i,u){t.GetDistanceTime(i,u).then(function(t){r.selectedQuote.Stops[n].distanceFromPrevious=t.distance;r.selectedQuote.Stops[n].timeFromPrevious=t.time})};r.ScopeDialogInitialize=function(n){for(var t=0;t<r.$parent.selectedQuote.Stops.length;t++)r.$parent.selectedQuote.Stops[t].id==n&&(r.selectedStop=r.$parent.selectedQuote.Stops[t]);r.InitEditStop()};r.InitEditStop=function(){r.SearchAddress="";r.stopDialog=!0;t.GetStates().then(function(n){$.each(JSON.parse(n),function(n,t){r.statesCodes=r.statesCodes.concat(t);r.states=r.states.concat(n)});var f=encodeURI(r.selectedStop.address.replace(/[#?$+,\/:&;=@%{}|\\\[\]\^~]/g,"")),e="http://maps.googleapis.com/maps/api/streetview?size=400x300&location="+f+"&sensor=false";u.find("#mapImg").attr("src",e);i(function(){t.GetBuildingType(r.BuildingType[0]).then(function(n){var u=JSON.parse(n.buildings);r.Buildings[0]=[];r.BuildingsCodes[0]=[];r.Buildings[1]=[];r.BuildingsCodes[1]=[];r.Buildings[2]=[];r.BuildingsCodes[2]=[];$.each(u,function(n,t){r.Buildings[0]=r.Buildings[0].concat(t);r.BuildingsCodes[0]=r.BuildingsCodes[0].concat(n)});i(function(){t.GetBuildingType(r.BuildingType[1]).then(function(n){u=JSON.parse(n.buildings);$.each(u,function(n,t){r.Buildings[1]=r.Buildings[1].concat(t);r.BuildingsCodes[1]=r.BuildingsCodes[1].concat(n)});i(function(){t.GetBuildingType(r.BuildingType[2]).then(function(n){u=JSON.parse(n.buildings);$.each(u,function(n,t){r.Buildings[2]=r.Buildings[2].concat(t);r.BuildingsCodes[2]=r.BuildingsCodes[2].concat(n)})})})})})})})});r.SetPreviousSelectedStop();r.InitMaps();i(function(){r.$apply()})};r.Clear=function(){r.selectedStop={};r.stopDialog=!1};r.AddStop=function(){r.$parent.selectedQuote.Stops.push(r.selectedStop);n.UpdateStops(r.$parent.selectedQuote.QuoteID,r.$parent.selectedQuote.Stops);n.servicePromise.promise.then(function(){r.RefreshStops()})};r.DeleteStop=function(){var t=r.selectedStop.id;n.DeleteStop(t);n.servicePromise.promise.then(function(n){n=="OK"&&r.RefreshStops()});r.Clear()};r.InitMaps=function(){var i=u.find("#searchTextField")[0],t=new f.google.maps.places.Autocomplete(i,{componentRestrictions:{country:"us"}});f.google.maps.event.addListener(t,"place_changed",function(){function e(n,t){t=t||"long_name";var i=_.filter(o.address_components,function(t){return _.any(t.types,function(t){return t===n})})[0];return i?i[t]:""}var o=t.getPlace(),i,f,s,h;o.address_components?(i={street1:e("street_number")+" "+e("route"),city:e("locality"),state:e("administrative_area_level_1","short_name"),zip:e("postal_code")},r.selectedStop.street1=i.street1,r.selectedStop.city=i.city,r.selectedStop.state=i.state,r.selectedStop.zip=i.zip,f={},f.street1=i.street1,f.street2="",f.city=i.city,f.state=i.state,f.zip=i.zip,f.display=i.street1+" "+i.street2+" "+i.city+" , "+i.state+" "+i.zip,f.street1&&(s=encodeURI(f.display.replace(/[#?$+,\/:&;=@%{}|\\\[\]\^~]/g,"")),h="http://maps.googleapis.com/maps/api/streetview?size=400x300&location="+s+"&sensor=false",u.find("#mapImg").attr("src",h)),n.AddressSuggestions(f),n.servicePromise.promise.then(function(n){var t,f;if(r.loadFirstTime=!1,n.length>0)for(r.verifiedAddress=n,u.find("#unverifiedAddressResult").empty(),u.find("#verifiedAddressResult").empty(),t=0;t<r.verifiedAddress.length;t++){f=$("<div> <\/div>");f.appendTo(u.find("#verifiedAddressResult"));var e="rdo"+t,o=$('<input style="float:left" type="radio" data-index="'+t+'" name="address" id="'+e+'" />'),s=$('<label for="'+e+'" >'+r.verifiedAddress[t].displayString()+"<\/label>");if(o.click(function(){var n=$(this).attr("data-index");r.selectedStop.street1=r.verifiedAddress[n].json.delivery_line_1;r.selectedStop.zip=r.verifiedAddress[n].json.components.zipcode;r.selectedStop.city=r.verifiedAddress[n].json.components.city_name;r.selectedStop.state=r.verifiedAddress[n].json.components.state_abbreviation;r.$apply()}),o.appendTo(u.find(f)),s.appendTo(u.find(f)),t==r.verifiedAddress.length-1)break}else{u.find("#unverifiedAddressResult").empty();u.find("#verifiedAddressResult").empty();f=$('<div style="width:100%"><\/div>');f.appendTo(u.find("#unverifiedAddressResult"));var e="rdo"+t,o=$('<input style="float:left" type="radio" name="address" id="'+e+'" />'),s=$('<label for="'+e+'" >'+i.street1+" , "+i.city+" , "+i.state+" , "+i.zip+"<\/label>");o.appendTo(u.find(f));s.appendTo(u.find(f))}r.SetPreviousSelectedStop()}),i.zip):o.name&&u.find("#street1").val(o.name).focus()})};r.FindAddress=function(){var t,i,f;r.loadFirstTime=!1;t={};t.street1=r.selectedStop.street1;t.street2=r.selectedStop.street2;t.city=r.selectedStop.city;t.state=r.selectedStop.state;t.zip=r.selectedStop.zip;t.display=t.street1+" "+t.street2+" "+t.city+" , "+t.state+" "+t.zip;t.street1&&(i=encodeURI(t.display.replace(/[#?$+,\/:&;=@%{}|\\\[\]\^~]/g,"")),f="http://maps.googleapis.com/maps/api/streetview?size=400x300&location="+i+"&sensor=false",u.find("#mapImg").attr("src",f));n.AddressSuggestions(t);n.servicePromise.promise.then(function(n){var t,i;if(u.find("#unverifiedAddressResult").empty(),u.find("#verifiedAddressResult").empty(),u.find("#previouslySelectedResult").empty(),n.length>0)for(r.loadFirstTime=!1,r.verifiedAddress=n,u.find("#unverifiedAddressResult").empty(),u.find("#verifiedAddressResult").empty(),t=0;t<r.verifiedAddress.length;t++){i=$("<div> <\/div>");i.appendTo(u.find("#verifiedAddressResult"));var f="rdo"+t,e=$('<input style="float:left" type="radio" data-index="'+t+'" name="address" id="'+f+'" />'),o=$('<label for="'+f+'" >'+r.verifiedAddress[t].displayString()+"<\/label>");if(e.click(function(){var n=$(this).attr("data-index");r.selectedStop.street1=r.verifiedAddress[n].json.delivery_line_1;r.selectedStop.zip=r.verifiedAddress[n].json.components.zipcode;r.selectedStop.city=r.verifiedAddress[n].json.components.city_name;r.selectedStop.state=r.verifiedAddress[n].json.components.state_abbreviation;r.$apply()}),e.appendTo(u.find(i)),o.appendTo(u.find(i)),t==r.verifiedAddress.length-1)break}else{u.find("#unverifiedAddressResult").empty();u.find("#verifiedAddressResult").empty();i=$('<div style="width:100%"><\/div>');i.appendTo(u.find("#unverifiedAddressResult"));var f="rdo"+t,e=$('<input style="float:left" type="radio" name="address" id="'+f+'" />'),o=$('<label for="'+f+'" >'+vals.street1+" , "+vals.city+" , "+vals.state+" , "+vals.zip+"<\/label>");e.appendTo(u.find(i));o.appendTo(u.find(i))}r.SetPreviousSelectedStop()})};r.ShowMap=function(){};r.SetPreviousSelectedStop=function(){var n,t,i,f;r.selectedStop.address&&(u.find("#previouslySelectedResult").empty(),n=$('<div style="width:100%"><\/div>'),n.appendTo(u.find("#previouslySelectedResult")),t="rdo1",i=null,i=r.loadFirstTime==!0?$('<input style="float:left" type="radio" name="address" id="'+t+'" checked/>'):$('<input style="float:left" type="radio" name="address" id="'+t+'" />'),f=$('<label for="'+t+'" >'+r.selectedStop.address+"<\/label>"),i.click(function(){var n=r.selectedStop.address.split(","),t;r.selectedStop.street1=n[0];r.selectedStop.city=n[1];t=n[2].split(" ");r.selectedStop.state=t[1];r.selectedStop.zip=t[2];r.$apply()}),i.appendTo(u.find(n)),f.appendTo(u.find(n)))};r.Init=function(){r.GetFranchise();r.RefreshStops()};r.Init()}quoteApp.controller("manageStops",["quoteFactory","addressFactory","$timeout","$scope","$element","$window",manageStops]);