(function(n){"use strict";var t=function(t){var i=n.Deferred(),r=new FileReader;return r.onload=function(n){i.resolve(n.target.result)},r.onerror=i.reject,r.onprogress=i.notify,r.readAsDataURL(t),i.promise()};n.fn.cleanHtml=function(){var t=n(this).html();return t&&t.replace(/(<br>|\s|<div><br><\/div>|&nbsp;)*$/,"")};n.fn.wysiwyg=function(i){var u=this,s,r,h,c=function(){r.activeToolbarClass&&n(r.toolbarSelector).find(h).each(function(){var t=n(this).data(r.commandRole);document.queryCommandState(t)?n(this).addClass(r.activeToolbarClass):n(this).removeClass(r.activeToolbarClass)})},o=function(n,t){var i=n.split(" "),r=i.shift(),u=i.join(" ")+(t||"");document.execCommand(r,0,u);c()},y=function(t){n.each(t,function(n,t){u.keydown(n,function(n){u.attr("contenteditable")&&u.is(":visible")&&(n.preventDefault(),n.stopPropagation(),o(t))}).keyup(n,function(n){u.attr("contenteditable")&&u.is(":visible")&&(n.preventDefault(),n.stopPropagation())})})},l=function(){var n=window.getSelection();if(n.getRangeAt&&n.rangeCount)return n.getRangeAt(0)},f=function(){s=l()},e=function(){var n=window.getSelection();if(s){try{n.removeAllRanges()}catch(t){document.body.createTextRange().select();document.selection.empty()}n.addRange(s)}},a=function(i){u.focus();n.each(i,function(i,u){/^image\//.test(u.type)?n.when(t(u)).done(function(n){o("insertimage",n)}).fail(function(n){r.fileUploadError("file-reader",n)}):r.fileUploadError("unsupported-file-type",u.type)})},v=function(n,t){e();document.queryCommandSupported("hiliteColor")&&document.execCommand("hiliteColor",0,t||"transparent");f();n.data(r.selectionMarker,t)},p=function(t,i){t.find(h).click(function(){e();u.focus();o(n(this).data(i.commandRole));f()});t.find("[data-toggle=dropdown]").click(e);t.find("input[type=text][data-"+i.commandRole+"]").on("webkitspeechchange change",function(){var t=this.value;this.value="";e();t&&(u.focus(),o(n(this).data(i.commandRole),t));f()}).on("focus",function(){var t=n(this);t.data(i.selectionMarker)||(v(t,i.selectionColor),t.focus())}).on("blur",function(){var t=n(this);t.data(i.selectionMarker)&&v(t,!1)});t.find("input[type=file][data-"+i.commandRole+"]").change(function(){e();this.type==="file"&&this.files&&this.files.length>0&&a(this.files);f();this.value=""})},w=function(){u.on("dragenter dragover",!1).on("drop",function(n){var t=n.originalEvent.dataTransfer;n.stopPropagation();n.preventDefault();t&&t.files&&t.files.length>0&&a(t.files)})};r=n.extend({},n.fn.wysiwyg.defaults,i);h="a[data-"+r.commandRole+"],button[data-"+r.commandRole+"],input[type=button][data-"+r.commandRole+"]";y(r.hotKeys);r.dragAndDropImages&&w();p(n(r.toolbarSelector),r);u.attr("contenteditable",!0).on("mouseup keyup mouseout",function(){f();c()});return n(window).bind("touchend",function(n){var i=u.is(n.target)||u.has(n.target).length>0,t=l(),r=t&&t.startContainer===t.endContainer&&t.startOffset===t.endOffset;(!r||i)&&(f(),c())}),this};n.fn.wysiwyg.defaults={hotKeys:{"ctrl+b meta+b":"bold","ctrl+i meta+i":"italic","ctrl+u meta+u":"underline","ctrl+z meta+z":"undo","ctrl+y meta+y meta+shift+z":"redo","ctrl+l meta+l":"justifyleft","ctrl+r meta+r":"justifyright","ctrl+e meta+e":"justifycenter","ctrl+j meta+j":"justifyfull","shift+tab":"outdent",tab:"indent"},toolbarSelector:"[data-role=editor-toolbar]",commandRole:"edit",activeToolbarClass:"btn-info",selectionMarker:"edit-focus-marker",selectionColor:"darkgrey",dragAndDropImages:!0,fileUploadError:function(n,t){console.log("File upload error",n,t)}}})(window.jQuery);